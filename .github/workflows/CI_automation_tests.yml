name: CI - Automation (Sanity & Regression)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    # Run daily at 2:00 AM SAST (00:00 UTC)
    - cron: '0 0 * * *'

env:
  PYTHON_VERSION: '3.10'
  PYTHONUNBUFFERED: '1'

jobs:
  sanity-tests:
    name: üß™ Sanity (${{ matrix.os }}-${{ matrix.browser }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        browser: [chromium, firefox, webkit]

    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4

    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip list | grep -E "(playwright|pytest|pytest-playwright)" || (echo "Critical dependencies missing!" && exit 1)
        python -c "import pytest_playwright; print('pytest-playwright imported successfully')" || (echo "pytest-playwright not properly installed!" && exit 1)

    - name: üé≠ Cache Playwright Browsers
      uses: actions/cache@v4
      with:
        path: ${{ runner.os == 'macOS' && '~/Library/Caches/ms-playwright' || '~/.cache/ms-playwright' }}
        key: ${{ runner.os }}-playwright-${{ matrix.browser }}-${{ hashFiles('**/requirements.txt') }}-${{ hashFiles('**/pytest.ini') }}
        restore-keys: |
          ${{ runner.os }}-playwright-${{ matrix.browser }}-

    - name: üé≠ Install Playwright Browsers
      run: |
        playwright install ${{ matrix.browser }} --with-deps
        playwright --version || (echo "Playwright installation failed!" && exit 1)

    - name: üîç Verify Test Configuration
      run: |
        if [ ! -f "pytest.ini" ]; then
          echo "Error: pytest.ini not found!"
          exit 1
        fi
        if [ ! -f "tests/e2e/saucedemo/test_login.py" ]; then
          echo "Error: Test file not found!"
          exit 1
        fi
        pytest --collect-only tests/e2e/saucedemo/test_login.py -q --browser ${{ matrix.browser }} || (echo "Test collection failed!" && exit 1)
        echo "Test configuration verified ‚úì"

    - name: üß™ Run Sanity Tests
      run: |
        echo "Running sanity tests on ${{ matrix.browser }}..."
        mkdir -p Artifacts/Reports
        pytest tests/e2e/saucedemo/test_login.py -v \
          --browser ${{ matrix.browser }} \
          --html=Artifacts/Reports/sanity_report_${{ matrix.browser }}.html \
          --self-contained-html \
          --tb=short \
          --timeout=30 \
          --maxfail=1 \
          --strict-markers
      continue-on-error: false

    - name: üì§ Upload Sanity Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Sanity-Test-Report-${{ matrix.os }}-${{ matrix.browser }}
        path: Artifacts/Reports/sanity_report_${{ matrix.browser }}.html
        if-no-files-found: ignore
        retention-days: 7

    - name: üìä Sanity Test Summary
      if: always()
      run: |
        if [ -f "Artifacts/Reports/sanity_report_${{ matrix.browser }}.html" ]; then
          echo "‚úÖ Sanity test report generated (${{ matrix.browser }})"
        else
          echo "‚ö†Ô∏è Warning: Test report not found"
        fi

  regression-tests:
    name: üîÑ Regression (${{ matrix.os }}-${{ matrix.browser }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 35
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        browser: [chromium, firefox, webkit]

    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4

    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip list | grep -E "(playwright|pytest|pytest-playwright)" || (echo "Critical dependencies missing!" && exit 1)
        python -c "import pytest_playwright; print('pytest-playwright imported successfully')" || (echo "pytest-playwright not properly installed!" && exit 1)

    - name: üé≠ Cache Playwright Browsers
      uses: actions/cache@v4
      with:
        path: ${{ runner.os == 'macOS' && '~/Library/Caches/ms-playwright' || '~/.cache/ms-playwright' }}
        key: ${{ runner.os }}-playwright-${{ matrix.browser }}-${{ hashFiles('**/requirements.txt') }}-${{ hashFiles('**/pytest.ini') }}
        restore-keys: |
          ${{ runner.os }}-playwright-${{ matrix.browser }}-

    - name: üé≠ Install Playwright Browsers
      run: |
        playwright install ${{ matrix.browser }} --with-deps
        playwright --version || (echo "Playwright installation failed!" && exit 1)

    - name: üîç Verify Test Configuration
      run: |
        if [ ! -f "pytest.ini" ]; then
          echo "Error: pytest.ini not found!"
          exit 1
        fi
        test_count=$(find tests/e2e/saucedemo -name "test_*.py" | wc -l)
        if [ "$test_count" -eq 0 ]; then
          echo "Error: No test files found in tests/e2e/saucedemo/"
          exit 1
        fi
        pytest --collect-only tests/e2e/saucedemo/ -q --browser ${{ matrix.browser }} || (echo "Test collection failed!" && exit 1)
        echo "Found $test_count test file(s) ‚úì"

    - name: üîÑ Run Regression Tests
      run: |
        echo "Running regression tests on ${{ matrix.browser }}..."
        mkdir -p Artifacts/Reports
        pytest tests/e2e/saucedemo/ -v \
          --browser ${{ matrix.browser }} \
          --html=Artifacts/Reports/regression_report_${{ matrix.browser }}.html \
          --self-contained-html \
          --tb=short \
          --timeout=30 \
          --maxfail=5 \
          --strict-markers
      continue-on-error: false

    - name: üì§ Upload Regression Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Regression-Test-Report-${{ matrix.os }}-${{ matrix.browser }}
        path: Artifacts/Reports/regression_report_${{ matrix.browser }}.html
        if-no-files-found: ignore
        retention-days: 7

    - name: üìä Regression Test Summary
      if: always()
      run: |
        if [ -f "Artifacts/Reports/regression_report_${{ matrix.browser }}.html" ]; then
          echo "‚úÖ Regression test report generated (${{ matrix.browser }})"
        else
          echo "‚ö†Ô∏è Warning: Test report not found"
        fi

  code-quality:
    name: üìù Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4

    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Install Linters
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint
        pip list | grep -E "(flake8|pylint)" || (echo "Linters not installed!" && exit 1)

    - name: üîç Verify Code Files Exist
      run: |
        if [ ! -d "src" ] || [ ! -d "tests" ]; then
          echo "Error: Code directories (src/, tests/) not found!"
          exit 1
        fi
        echo "Code directories verified ‚úì"

    - name: üîç Run Flake8 (Critical Errors)
      run: |
        echo "Running Flake8 critical error checks..."
        flake8 src/ tests/ \
          --count \
          --select=E9,F63,F7,F82 \
          --show-source \
          --statistics

    - name: üîç Run Flake8 (Style Checks)
      run: |
        echo "Running Flake8 style checks..."
        flake8 src/ tests/ \
          --count \
          --exit-zero \
          --max-complexity=10 \
          --max-line-length=127 \
          --statistics

    - name: üîç Run Pylint
      run: |
        echo "Running Pylint..."
        pylint src/automation_testing_playground/ tests/ \
          --disable=all \
          --enable=E,F \
          --exit-zero \
          --ignore=venv,.venv

    - name: ‚úÖ Code Quality Summary
      if: always()
      run: |
        echo "‚úÖ Code quality checks completed"
        echo "All linting checks passed ‚úì"

  notify-on-failure:
    name: üìß Notify on Failure
    runs-on: ubuntu-latest
    needs: [sanity-tests, regression-tests, code-quality]
    if: failure()
    
    steps:
    - name: üìß Send Failure Notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "‚ùå CI Workflow Failed - automation-testing-playground"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          The CI workflow for automation-testing-playground has failed.
          
          Repository: ${{ github.repository }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_id }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          
          View the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Please check the workflow logs for details.
        secure: true
      continue-on-error: true

