name: CI - Automation (Sanity & Regression)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    # Run daily at 2:00 AM SAST (00:00 UTC)
    - cron: '0 0 * * *'

env:
  PYTHON_VERSION: '3.10'
  PYTHONUNBUFFERED: '1'

jobs:
  sanity-tests:
    name: ğŸ§ª Sanity Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip list | grep -E "(playwright|pytest|pytest-playwright)" || (echo "Critical dependencies missing!" && exit 1)
        python -c "import pytest_playwright; print('pytest-playwright imported successfully')" || (echo "pytest-playwright not properly installed!" && exit 1)

    - name: ğŸ­ Cache Playwright Browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}-${{ hashFiles('**/pytest.ini') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: ğŸ­ Install Playwright Browsers
      run: |
        playwright install chromium --with-deps
        playwright --version || (echo "Playwright installation failed!" && exit 1)

    - name: ğŸ” Verify Test Configuration
      run: |
        if [ ! -f "pytest.ini" ]; then
          echo "Error: pytest.ini not found!"
          exit 1
        fi
        if [ ! -f "tests/saucedemo/test_login.py" ]; then
          echo "Error: Test file not found!"
          exit 1
        fi
        pytest --collect-only tests/saucedemo/test_login.py -q || (echo "Test collection failed!" && exit 1)
        echo "Test configuration verified âœ“"

    - name: ğŸ§ª Run Sanity Tests
      run: |
        echo "Running sanity tests..."
        mkdir -p Artifacts/Reports
        pytest tests/saucedemo/test_login.py -v \
          --html=Artifacts/Reports/sanity_report.html \
          --self-contained-html \
          --tb=short \
          --timeout=30 \
          --maxfail=1 \
          --strict-markers
      continue-on-error: false

    - name: ğŸ“¤ Upload Sanity Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Sanity-Test-Report
        path: Artifacts/Reports/sanity_report.html
        if-no-files-found: ignore
        retention-days: 7

    - name: ğŸ“Š Sanity Test Summary
      if: always()
      run: |
        if [ -f "Artifacts/Reports/sanity_report.html" ]; then
          echo "âœ… Sanity test report generated"
        else
          echo "âš ï¸ Warning: Test report not found"
        fi

  regression-tests:
    name: ğŸ”„ Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip list | grep -E "(playwright|pytest|pytest-playwright)" || (echo "Critical dependencies missing!" && exit 1)
        python -c "import pytest_playwright; print('pytest-playwright imported successfully')" || (echo "pytest-playwright not properly installed!" && exit 1)

    - name: ğŸ­ Cache Playwright Browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}-${{ hashFiles('**/pytest.ini') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: ğŸ­ Install Playwright Browsers
      run: |
        playwright install chromium --with-deps
        playwright --version || (echo "Playwright installation failed!" && exit 1)

    - name: ğŸ” Verify Test Configuration
      run: |
        if [ ! -f "pytest.ini" ]; then
          echo "Error: pytest.ini not found!"
          exit 1
        fi
        test_count=$(find tests/saucedemo -name "test_*.py" | wc -l)
        if [ "$test_count" -eq 0 ]; then
          echo "Error: No test files found in tests/saucedemo/"
          exit 1
        fi
        pytest --collect-only tests/saucedemo/ -q || (echo "Test collection failed!" && exit 1)
        echo "Found $test_count test file(s) âœ“"

    - name: ğŸ”„ Run Regression Tests
      run: |
        echo "Running regression tests..."
        mkdir -p Artifacts/Reports
        pytest tests/saucedemo/ -v \
          --html=Artifacts/Reports/regression_report.html \
          --self-contained-html \
          --tb=short \
          --timeout=30 \
          --maxfail=5 \
          --strict-markers
      continue-on-error: false

    - name: ğŸ“¤ Upload Regression Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Regression-Test-Report
        path: Artifacts/Reports/regression_report.html
        if-no-files-found: ignore
        retention-days: 7

    - name: ğŸ“Š Regression Test Summary
      if: always()
      run: |
        if [ -f "Artifacts/Reports/regression_report.html" ]; then
          echo "âœ… Regression test report generated"
        else
          echo "âš ï¸ Warning: Test report not found"
        fi

  code-quality:
    name: ğŸ“ Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Linters
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint
        pip list | grep -E "(flake8|pylint)" || (echo "Linters not installed!" && exit 1)

    - name: ğŸ” Verify Code Files Exist
      run: |
        if [ ! -d "pages" ] || [ ! -d "tests" ]; then
          echo "Error: Code directories not found!"
          exit 1
        fi
        echo "Code directories verified âœ“"

    - name: ğŸ” Run Flake8 (Critical Errors)
      run: |
        echo "Running Flake8 critical error checks..."
        flake8 pages/ tests/ \
          --count \
          --select=E9,F63,F7,F82 \
          --show-source \
          --statistics

    - name: ğŸ” Run Flake8 (Style Checks)
      run: |
        echo "Running Flake8 style checks..."
        flake8 pages/ tests/ \
          --count \
          --exit-zero \
          --max-complexity=10 \
          --max-line-length=127 \
          --statistics

    - name: ğŸ” Run Pylint
      run: |
        echo "Running Pylint..."
        pylint pages/*.py tests/**/*.py \
          --disable=all \
          --enable=E,F \
          --exit-zero

    - name: âœ… Code Quality Summary
      if: always()
      run: |
        echo "âœ… Code quality checks completed"
        echo "All linting checks passed âœ“"

  notify-on-failure:
    name: ğŸ“§ Notify on Failure
    runs-on: ubuntu-latest
    needs: [sanity-tests, regression-tests, code-quality]
    if: failure()
    
    steps:
    - name: ğŸ“§ Send Failure Notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âŒ CI Workflow Failed - automation-testing-playground"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          The CI workflow for automation-testing-playground has failed.
          
          Repository: ${{ github.repository }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_id }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          
          View the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Please check the workflow logs for details.
        secure: true
      continue-on-error: true

